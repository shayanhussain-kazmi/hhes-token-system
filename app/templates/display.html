<!doctype html>
<html>
<head>
  <title>Now Serving</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body class="display-body">
  <div class="display-page">
    <header class="display-header">Happy Home English School Sharjah</header>

    <main class="display-main">
      <section class="display-now-serving">
        <h1 class="display-section-title">Now Serving</h1>
        <div id="nowCards" class="now-cards"></div>
      </section>

      <aside class="display-video-panel">
        <h2 class="display-section-title">Promotions</h2>
        <div class="video-frame">
          <video id="promoVideo" autoplay muted loop playsinline>
            <source src="/static/media/promo.mp4" type="video/mp4">
          </video>
          <div id="videoPlaceholder" class="video-placeholder" hidden>Promo video not uploaded</div>
        </div>
      </aside>
    </main>

    <section class="display-recent">
      <h2 class="display-section-title">Recently Served</h2>
      <div id="recentCards" class="recent-cards"></div>
    </section>

    <footer class="display-footer">Thank you for visiting | Call: 06 566 1903 | Contact: principal@happyhomeenglishsch.com</footer>
  </div>

  <div id="audioBanner" class="audio-banner" hidden>Audio may require user interaction once to enable announcements.</div>

  <script>
    function escapeHtml(text) {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return String(text).replace(/[&<>"']/g, m => map[m]);
    }

    const announcedIds = new Set(JSON.parse(localStorage.getItem('display_announced_ids') || '[]'));

    function saveAnnouncedIds() {
      const compact = Array.from(announcedIds).slice(-20);
      localStorage.setItem('display_announced_ids', JSON.stringify(compact));
    }

    function speakableToken(token) {
      const [letters = '', numbers = ''] = String(token).split('-');
      const letterPart = letters.toUpperCase().split('').join(' ');
      const numberPart = numbers.split('').map(ch => (ch >= '0' && ch <= '9' ? ['zero','one','two','three','four','five','six','seven','eight','nine'][Number(ch)] : ch)).join(' ');
      return `${letterPart} ${numberPart}`.trim();
    }

    function showAudioBanner(show) {
      document.getElementById('audioBanner').hidden = !show;
    }

    function pickAnnouncementVoice() {
      const voices = window.speechSynthesis?.getVoices?.() || [];
      const englishVoices = voices.filter(voice => String(voice.lang || '').toLowerCase().startsWith('en'));
      if (!englishVoices.length) return null;

      const preferredVoiceHints = [
        'zira',
        'samantha',
        'female',
        'google uk english female',
        'karen',
        'tessa',
        'serena'
      ];

      const preferred = englishVoices.find(voice => {
        const name = String(voice.name || '').toLowerCase();
        return preferredVoiceHints.some(hint => name.includes(hint));
      });

      return preferred || englishVoices[0] || null;
    }

    async function playChime() {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if (!AudioCtx) throw new Error('Audio context not available');
      const ctx = new AudioCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(880, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(660, ctx.currentTime + 0.2);
      gain.gain.setValueAtTime(0.001, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.15, ctx.currentTime + 0.03);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.26);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + 0.26);
      await new Promise(resolve => setTimeout(resolve, 300));
      await ctx.close();
    }

    async function announceToken(item) {
      const message = `Token number ${speakableToken(item.token_number)}, please proceed to ${item.department}.`;
      try {
        await playChime();
        const utterance = new SpeechSynthesisUtterance(message);
        const selectedVoice = pickAnnouncementVoice();
        if (selectedVoice) {
          utterance.voice = selectedVoice;
        }
        utterance.rate = 0.80;
        utterance.pitch = 1.05;
        utterance.volume = 1.0;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
        showAudioBanner(false);
      } catch (error) {
        showAudioBanner(true);
      }
    }

    async function refresh() {
      const res = await fetch('/api/display');
      const data = await res.json();

      const nowServing = data.nowServing.slice(0, 4);
      document.getElementById('nowCards').innerHTML = nowServing.length
        ? nowServing.map(item => `
          <article class="now-card">
            <div class="now-token">${escapeHtml(item.token_number)}</div>
            <div class="now-department">${escapeHtml(item.department)}</div>
          </article>
        `).join('')
        : '<p class="subtle">No active calls</p>';

      const newCalls = nowServing.filter(item => item.id && !announcedIds.has(item.id));
      for (const called of newCalls) {
        announcedIds.add(called.id);
        await announceToken(called);
      }
      if (newCalls.length) {
        saveAnnouncedIds();
      }

      const recent = data.recentCompleted.slice(0, 6);
      document.getElementById('recentCards').innerHTML = recent.length
        ? recent.map(item => `
          <article class="recent-chip">
            <div class="recent-token">${escapeHtml(item.token_number)}</div>
            <div class="recent-department">${escapeHtml(item.department)}</div>
          </article>
        `).join('')
        : '<p class="subtle">No recently served tokens</p>';
    }

    const promoVideo = document.getElementById('promoVideo');
    const videoPlaceholder = document.getElementById('videoPlaceholder');
    promoVideo.addEventListener('error', () => {
      promoVideo.hidden = true;
      videoPlaceholder.hidden = false;
    });

    document.addEventListener('click', () => showAudioBanner(false));

    refresh();
    setInterval(refresh, 4000);
  </script>
</body>
</html>
